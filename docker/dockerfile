# Stage 1: PHP base (instala Composer e Ziggy)
FROM php:8.2-fpm AS php_base

WORKDIR /var/www

RUN apt-get update && apt-get install -y \
    git curl libpng-dev libonig-dev libxml2-dev zip unzip \
    && docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

COPY composer.json composer.lock ./
RUN composer install --no-dev --optimize-autoloader

COPY . .
RUN php artisan ziggy:generate

# Stage 2: Node build (Vite assets)
FROM node:20-alpine AS node_builder

WORKDIR /var/www

COPY package*.json ./
RUN npm install

COPY resources/js/ resources/js/
COPY resources/scss/ resources/scss/
COPY vite.config.js ./

# Copia ziggy.js gerado pelo stage PHP
COPY --from=php_base /var/www/public/js/ziggy.js ./public/js/ziggy.js

RUN npm run build

# Stage 3: Final PHP container
FROM php:8.2-fpm

WORKDIR /var/www

RUN apt-get update && apt-get install -y \
    git curl libpng-dev libonig-dev libxml2-dev zip unzip \
    && docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Copia c√≥digo PHP
COPY --from=php_base /var/www /var/www

# Copia assets buildados do Node
COPY --from=node_builder /var/www/public/build ./public/build

EXPOSE 9000
CMD ["php-fpm"]
